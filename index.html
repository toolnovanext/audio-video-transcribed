<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Transcription Service</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.18/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.10/clipboard.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .header {
            background: linear-gradient(90deg, #007bff, #00d4ff);
            color: #fff;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        .header p {
            margin: 5px 0 0;
            font-size: 1.2em;
            font-weight: 300;
        }
        .container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .media-player {
            width: 100%;
            max-height: 400px;
            margin-bottom: 20px;
            display: none;
            border-radius: 8px;
        }
        .file-upload-btn, .action-btn {
            background: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
        }
        .file-upload-btn:hover, .action-btn:hover {
            background: #0056b3;
        }
        .action-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .action-btn.copied {
            background: #28a745;
        }
        #fileInput {
            display: none;
        }
        .transcription-card {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .transcription-content {
            white-space: pre-wrap;
            min-height: 100px;
        }
        .error {
            color: #d32f2f;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #ffe6e6;
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #555;
        }
        .collapsible {
            cursor: pointer;
            padding: 10px;
            background: #e9ecef;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 16px;
        }
        .collapsible[aria-expanded="true"]::after {
            content: '▲';
        }
        .collapsible[aria-expanded="false"]::after {
            content: '▼';
        }
        .collapsible-content {
            display: none;
            padding: 15px;
            background: #f1f3f5;
            border-radius: 6px;
        }
        .collapsible-content.active {
            display: block;
        }
        .welcome-message {
            text-align: center;
            margin-bottom: 20px;
            color: #555;
        }
        .welcome-message p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .action-buttons ul {
            list-style: none;
            padding: 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        h1, h3 {
            color: #333;
        }
        .transcription-heading {
            font-size: 1.5em;
            margin: 10px 0;
            color: #007bff;
            display: none;
        }
        .transcription-heading.active {
            display: block;
        }
        .toast-container {
            margin-top: 20px;
            text-align: center;
        }
    </style>
    <script src="https://toolnovanext.github.io/scripts/navigation.js" defer></script>
    <script src="https://toolnovanext.github.io/scripts/notification.js" defer></script>
</head>
<body>
    <div class="header">
        <h1>AI-Powered Transcription Service</h1>
        <p>Transform your audio and video files into accurate transcriptions with ease</p>
    </div>
    <div class="container">
        <div id="welcomeMessage" class="welcome-message">
            <p>Welcome to our AI-Powered Transcription Service, designed to deliver precise and efficient transcriptions.</p>
            <p>This service leverages advanced generative AI technology, which may occasionally produce errors.</p>
            <p>Developed by Sujan Rai at The Accessible Resource, this comprehensive tool enables seamless transcription of audio and video files.</p>
            <p>Upload your media file to generate a detailed transcription with accurate timestamps.</p>
        </div>
        <section class="control-buttons">
            <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">Upload Media File</button>
            <button id="removeBtn" style="display: none;" class="action-btn" onclick="removeMedia()">Remove Media File</button>
            <input type="file" id="fileInput" accept="video/mp4,video/x-matroska,video/webm,video/avi,video/mpeg,video/ogv,audio/mpeg,audio/wav,audio/ogg,audio/flac,audio/aac">
        </section>
        <video id="videoPlayer" class="media-player" controls></video>
        <audio id="audioPlayer" class="media-player" controls preload="none"></audio>
        <button id="transcribeBtn" class="action-btn" onclick="transcribeMedia()">Generate Transcription</button>
        <div id="loading" class="loading"></div>
        <div id="error" class="error"></div>
        <div id="transcriptions"></div>
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // API Configuration
        const API_KEY = 'AIzaSyC2Fsjk3yCRA8hDVYgg5LlMn4sxwoJJaWU';
        const selectedModel = 'gemini-2.5-pro';
        let currentFileUrl = null;
        let transcriptionCounter = 0;

        // DOM Elements
        const DOM = {
            fileInput: document.getElementById('fileInput'),
            videoPlayer: document.getElementById('videoPlayer'),
            audioPlayer: document.getElementById('audioPlayer'),
            transcribeBtn: document.getElementById('transcribeBtn'),
            removeBtn: document.getElementById('removeBtn'),
            transcriptionsDiv: document.getElementById('transcriptions'),
            errorDiv: document.getElementById('error'),
            loadingDiv: document.getElementById('loading'),
            welcomeMessage: document.getElementById('welcomeMessage'),
            toastContainer: document.getElementById('toastContainer')
        };

        // Supported file types
        const supportedFiles = {
            video: ['video/mp4', 'video/x-matroska', 'video/webm', 'video/avi', 'video/mpeg', 'video/ogv'],
            audio: ['audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/flac', 'audio/aac']
        };

        // File extension to MIME type mapping
        const extensionToMime = {
            '.mp4': 'video/mp4', '.mkv': 'video/x-matroska', '.webm': 'video/webm', '.avi': 'video/avi',
            '.mpeg': 'video/mpeg', '.ogv': 'video/ogv', '.mp3': 'audio/mpeg', '.wav': 'audio/wav',
            '.ogg': 'audio/ogg', '.flac': 'audio/flac', '.aac': 'audio/aac'
        };

        // Initialize collapsible listeners
        function initializeCollapsible() {
            document.querySelectorAll('.collapsible').forEach(btn => {
                btn.removeEventListener('click', handleCollapsibleClick);
                btn.addEventListener('click', handleCollapsibleClick);
            });
        }

        function handleCollapsibleClick(event) {
            const btn = event.currentTarget;
            const contentId = btn.getAttribute('aria-controls');
            toggleCollapsible(contentId);
        }

        // Toggle collapsible content
        function toggleCollapsible(contentId) {
            const content = document.getElementById(contentId);
            if (content) {
                const isActive = content.classList.toggle('active');
                const collapsible = content.previousElementSibling;
                if (collapsible) {
                    collapsible.setAttribute('aria-expanded', isActive);
                }
            }
        }

        // File selection handler
        DOM.fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                showError('No media file selected.');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                showError('File size exceeds 100MB limit.');
                DOM.fileInput.value = '';
                return;
            }

            resetMediaPlayers();
            DOM.welcomeMessage.style.display = 'none';
            DOM.removeBtn.style.display = 'inline-block';
            DOM.transcribeBtn.disabled = false;

            try {
                if (currentFileUrl) URL.revokeObjectURL(currentFileUrl);
                currentFileUrl = URL.createObjectURL(file);
                const mimeType = file.type || extensionToMime[`.${file.name.split('.').pop().toLowerCase()}`];

                if (supportedFiles.video.includes(mimeType)) {
                    DOM.videoPlayer.src = currentFileUrl;
                    DOM.videoPlayer.style.display = 'block';
                } else if (supportedFiles.audio.includes(mimeType)) {
                    DOM.audioPlayer.src = currentFileUrl;
                    DOM.audioPlayer.load();
                    DOM.audioPlayer.style.display = 'block';
                } else {
                    showError('Unsupported file type. Please upload a supported video or audio file.');
                    resetMediaPlayers();
                    DOM.fileInput.value = '';
                    DOM.transcribeBtn.disabled = true;
                    DOM.removeBtn.style.display = 'none';
                    DOM.welcomeMessage.style.display = 'block';
                    return;
                }
                clearError();
            } catch (error) {
                showError(`Error loading media file: ${error.message}`);
                resetMediaPlayers();
                DOM.fileInput.value = '';
                DOM.transcribeBtn.disabled = true;
                DOM.removeBtn.style.display = 'none';
                DOM.welcomeMessage.style.display = 'block';
            }
        });

        // Remove uploaded file
        function removeMedia() {
            DOM.fileInput.value = '';
            resetMediaPlayers();
            DOM.transcribeBtn.disabled = true;
            DOM.removeBtn.style.display = 'none';
            DOM.welcomeMessage.style.display = 'block';
            if (currentFileUrl) {
                URL.revokeObjectURL(currentFileUrl);
                currentFileUrl = null;
            }
            clearError();
        }

        // Reset media players
        function resetMediaPlayers() {
            ['videoPlayer', 'audioPlayer'].forEach(id => {
                DOM[id].style.display = 'none';
                DOM[id].src = '';
                if (id === 'audioPlayer') {
                    DOM.audioPlayer.pause();
                    DOM.audioPlayer.currentTime = 0;
                    DOM.audioPlayer.load();
                }
            });
        }

        // Reset everything for new transcription
        function resetEverything() {
            DOM.fileInput.value = '';
            resetMediaPlayers();
            DOM.transcribeBtn.disabled = true;
            DOM.removeBtn.style.display = 'none';
            DOM.welcomeMessage.style.display = 'block';
            DOM.transcriptionsDiv.innerHTML = '';
            transcriptionCounter = 0;
            if (currentFileUrl) {
                URL.revokeObjectURL(currentFileUrl);
                currentFileUrl = null;
            }
            clearError();
        }

        // Transcribe media content
        async function transcribeMedia(transcriptionId = null) {
            const file = DOM.fileInput.files[0];
            if (!file) {
                showError('Please select a media file to transcribe.');
                return;
            }

            const isRegenerate = !!transcriptionId;
            if (!isRegenerate) {
                transcriptionId = `transcription-${transcriptionCounter++}`;
                DOM.transcriptionsDiv.insertAdjacentHTML('afterbegin', `
                    <div class="transcription-card" id="${transcriptionId}">
                        <div id="transcriptionresponse-${transcriptionId}" class="transcription-content loading">Generating transcription...</div>
                    </div>
                `);
            } else {
                const transcriptionElement = document.getElementById(`transcriptionresponse-${transcriptionId}`);
                transcriptionElement.innerHTML = 'Generating transcription...';
                transcriptionElement.classList.add('loading');
            }

            showLoading(true, 'Processing transcription...');
            DOM.transcribeBtn.disabled = true;

            try {
                const base64Data = await fileToBase64(file);
                const mimeType = file.type || extensionToMime[`.${file.name.split('.').pop().toLowerCase()}`];

                const prompt = `Generate a highly accurate transcription of the provided audio or video file, including precise timestamps for each segment. The transcription should be performed in the original language of the media content. Format the output as well-structured Markdown, with each segment listed as a numbered item (e.g., - [00:01] ...). Ensure the list is sequential and uses three-digit numbering (e.g., 001, 002, etc.).`;

                if (!supportedFiles.video.includes(mimeType) && !supportedFiles.audio.includes(mimeType)) {
                    throw new Error('Unsupported file type for transcription.');
                }

                const response = await fetchAPI({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: mimeType, data: base64Data.split(',')[1] } }
                        ]
                    }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 8192, responseMimeType: 'text/plain' }
                });

                const transcription = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!transcription) throw new Error('No transcription received from API.');

                const transcriptionElement = document.getElementById(`transcriptionresponse-${transcriptionId}`);
                transcriptionElement.innerHTML = marked.parse(transcription, { gfm: true, breaks: true });
                transcriptionElement.classList.remove('loading');

                // Show transcription heading
                const heading = document.createElement('h3');
                heading.className = 'transcription-heading active';
                heading.textContent = 'Transcription';
                transcriptionElement.parentNode.insertBefore(heading, transcriptionElement);

                // Add or update action buttons
                let actionsContainer = document.getElementById(`actions-${transcriptionId}`);
                if (!actionsContainer) {
                    transcriptionElement.insertAdjacentHTML('afterend', `
                        <button class="collapsible" aria-expanded="false" aria-controls="actions-${transcriptionId}" role="button">Transcription Actions</button>
                        <div id="actions-${transcriptionId}" class="collapsible-content">
                            <div class="action-buttons">
                                <ul>
                                    <li><button class="copy-btn action-btn" data-clipboard-target="#transcriptionresponse-${transcriptionId}">Copy Transcription</button></li>
                                    <li><button class="action-btn" onclick="transcribeMedia('${transcriptionId}')">Regenerate Transcription</button></li>
                                    <li><button class="action-btn" onclick="downloadTranscription('transcriptionresponse-${transcriptionId}')">Download as PDF</button></li>
                                    <li><button class="action-btn" onclick="deleteTranscription('${transcriptionId}')">Delete Transcription</button></li>
                                </ul>
                            </div>
                        </div>

                        <p>generative AI might have made mistakes in transcription, regenerate for more accuracy.</p>
                        <button class="action-btn" onclick="resetEverything()">Start New Transcription</button>
                    `);
                }

                initializeCollapsible();
                new ClipboardJS(`#actions-${transcriptionId} .copy-btn`).on('success', handleCopySuccess).on('error', handleCopyError);
            } catch (error) {
                showError(`Error processing transcription: ${error.message}`);
                if (!isRegenerate) document.getElementById(transcriptionId)?.remove();
            } finally {
                DOM.transcribeBtn.disabled = false;
                showLoading(false);
                showToast(isRegenerate ? 'Transcription regenerated successfully.' : 'Transcription generated successfully.', 'success');
            }
        }

        // Utility functions
        async function fetchAPI(body) {
            try {
                const response = await axios.post(
                    `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${API_KEY}`,
                    body,
                    { headers: { 'Content-Type': 'application/json' } }
                );
                return response.data;
            } catch (error) {
                throw new Error(error.response?.data?.error?.message || `API request failed: ${error.message}`);
            }
        }

        function downloadTranscription(elementId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const element = document.getElementById(elementId);
            const text = element.textContent;

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');

            const lines = doc.splitTextToSize(text, 180);
            let y = 20;
            lines.forEach(line => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(line, 15, y);
                y += 7;
            });

            doc.save(`${elementId}.pdf`);
            showToast('Transcription downloaded as PDF successfully.', 'success');
        }

        function deleteTranscription(transcriptionId) {
            const element = document.getElementById(transcriptionId);
            if (element) {
                element.remove();
                showToast('Transcription deleted successfully.', 'success');
            }
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result;
                    if (base64String.length > 100 * 1024 * 1024 * 4 / 3) {
                        reject(new Error('Encoded file exceeds 100MB limit after base64 encoding.'));
                    } else {
                        resolve(base64String);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file.'));
                reader.readAsDataURL(file);
            });
        }

        function showLoading(show, message = '') {
            DOM.loadingDiv.textContent = message;
            DOM.loadingDiv.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            DOM.errorDiv.textContent = message;
            DOM.errorDiv.style.display = 'block';
            showToast(message, 'error');
            setTimeout(clearError, 5000);
        }

        function clearError() {
            DOM.errorDiv.textContent = '';
            DOM.errorDiv.style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const background = {
                success: '#28a745',
                error: '#dc3545',
                info: '#007bff'
            }[type];
            Toastify({
                text: message,
                duration: 5000,
                close: false,
                gravity: 'bottom',
                position: 'center',
                backgroundColor: background,
                stopOnFocus: true,
                destination: '#toastContainer'
            }).showToast();
        }

        function handleCopySuccess(e) {
            const btn = e.trigger;
            btn.textContent = 'Copied';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.textContent = 'Copy Transcription';
                btn.classList.remove('copied');
            }, 3000);
            e.clearSelection();
            showToast('Transcription copied to clipboard!', 'success');
        }

        function handleCopyError() {
            showError('Failed to copy transcription. Please try again.');
        }

        // Initialize collapsible listeners on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeCollapsible();
        });
    </script>
</body>
</html>
